From d3cdb626be30748b9360451023c75438ec346a38 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Roberto=20C=2E=20S=C3=A1nchez?= <roberto@connexer.com>
Date: Tue, 16 Jul 2024 16:15:16 -0400
Subject: [PATCH] CDRIVER-5601 more robust bson append (#1648)

Co-authored-by: Kevin Albertson <kevin.albertson@10gen.com>
Co-authored-by: Ezra Chung <88335979+eramongodb@users.noreply.github.com>

Origin: https://github.com/mongodb/mongo-c-driver/commit/d3cdb626be30748b9360451023c75438ec346a38
---
 src/libbson/src/bson/bson.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/src/libbson/src/bson/bson.c b/src/libbson/src/bson/bson.c
index adc5ee2cc8..e29b2a771c 100644
--- a/src/libbson/src/bson/bson.c
+++ b/src/libbson/src/bson/bson.c
@@ -324,7 +324,18 @@ _bson_append_va (bson_t *bson,              /* IN */
 
    buf = _bson_data (bson) + bson->len - 1;
 
+   /* Track running sum of bytes written in a uint64_t to detect possible overflow of `n_bytes`. */
+   uint64_t n_bytes_sum = 0;
    do {
+      // Size of any individual data being appended should not exceed the total byte limit.
+      if (BSON_UNLIKELY (bson_cmp_less_uu (n_bytes, data_len))) {
+         return false;
+      }
+      // Total size of data being appended should not exceed the total byte limit.
+      if (BSON_UNLIKELY (bson_cmp_greater_uu (n_bytes_sum, n_bytes - data_len))) {
+         return false;
+      }
+      n_bytes_sum += data_len;
       n_pairs--;
       /* data may be NULL if data_len is 0. memcpy is not safe to call with
        * NULL. */
-- 
2.39.5

