<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Basic Aggregation Examples</title>
<link rel="stylesheet" type="text/css" href="C.css">
<script type="text/javascript" src="jquery.js"></script><script type="text/javascript" src="jquery.syntax.js"></script><script type="text/javascript" src="yelp.js"></script>
</head>
<body><div class="page" role="main">
<div class="header"></div>
<div class="body">
<div class="hgroup"><h1 class="title"><span class="title">Basic Aggregation Examples</span></h1></div>
<div class="region">
<div class="contents"><p class="p">This document provides some practical, simple, examples to demonstrate the <span class="code">distinct</span> and <span class="code">mapReduce</span> commands.</p></div>
<div id="setup" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">Setup</span></h2></div>
<div class="region"><div class="contents">
<p class="p">First we'll write some code to insert sample data:</p>
<div class="code"><pre class="contents syntax brush-clang">/* Don't try to compile this file on it's own. It's meant to be #included
   by example code */

/* Insert some sample data */
bool insert_data (mongoc_collection_t* collection)
{
   mongoc_bulk_operation_t *bulk;
   enum N { ndocs = 4 };
   bson_t* docs[ndocs];
   bson_error_t error;
   int i = 0;
   bool ret;

   bulk = mongoc_collection_create_bulk_operation (collection, true, NULL);

   docs[0] = BCON_NEW ("x", BCON_DOUBLE (1.0), "tags", "[", "dog", "cat", "]");
   docs[1] = BCON_NEW ("x", BCON_DOUBLE (2.0), "tags", "[", "cat", "]");
   docs[2] = BCON_NEW ("x", BCON_DOUBLE (2.0), "tags",
                       "[", "mouse", "cat", "dog", "]");
   docs[3] = BCON_NEW ("x", BCON_DOUBLE (3.0), "tags", "[", "]");

   for (i = 0; i &lt; ndocs; i++) {
      mongoc_bulk_operation_insert (bulk, docs[i]);
      bson_destroy (docs[i]);
      docs[i] = NULL;
   }

   ret = mongoc_bulk_operation_execute (bulk, NULL, &amp;error);

   if (!ret) {
      fprintf (stderr, "Error inserting data: %s\n", error.message);
   }

   mongoc_bulk_operation_destroy (bulk);
   return ret;
}

/* A helper which we'll use a lot later on */
void print_res (const bson_t* reply)
{
   BSON_ASSERT (reply);
   char *str = bson_as_json (reply, NULL);
   printf ("%s\n", str);
   bson_free (str);
}</pre></div>
</div></div>
</div></div>
<div id="distinct" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">"distinct" command</span></h2></div>
<div class="region"><div class="contents">
<p class="p">This is how to use the <span class="code">distinct</span> command to get the distinct values of <span class="code">x</span> which are greater than <span class="code">1</span>:</p>
<div class="code"><pre class="contents syntax brush-clang">bool distinct (mongoc_database_t* database)
{
   bson_t* command;
   bson_t reply;
   bson_error_t error;
   bool res;
   bson_iter_t iter;
   bson_iter_t array_iter;
   double val;

   command = BCON_NEW ("distinct", BCON_UTF8 (COLLECTION_NAME),
                       "key", BCON_UTF8 ("x"),
                       "query", "{",
                       "x", "{", "$gt", BCON_DOUBLE (1.0), "}",
                       "}"
      );
   res = mongoc_database_command_simple (database, command, NULL,
                                         &amp;reply, &amp;error);
   if (!res) {
      fprintf (stderr, "Error with distinct: %s\n", error.message);
      goto cleanup;
   }

   /* Do something with reply (in this case iterate through the values) */
   if (!(bson_iter_init_find (&amp;iter, &amp;reply, "values") &amp;&amp;
         BSON_ITER_HOLDS_ARRAY (&amp;iter) &amp;&amp;
         bson_iter_recurse (&amp;iter, &amp;array_iter))) {
      fprintf (stderr, "Couldn't extract \"values\" field from response\n");
      goto cleanup;
   }

   while (bson_iter_next (&amp;array_iter)) {
      if (BSON_ITER_HOLDS_DOUBLE (&amp;array_iter)) {
         val = bson_iter_double (&amp;array_iter);
         printf ("Next double: %f\n", val);
      }
   }

cleanup:
   /* cleanup */
   bson_destroy (command);
   bson_destroy (&amp;reply);
   return res;
}</pre></div>
</div></div>
</div></div>
<div id="map-reduce-basic" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">"mapReduce" - basic example</span></h2></div>
<div class="region"><div class="contents">
<p class="p">A simple example using the map reduce framework. It simply adds up the number of occurrences of each "tag".</p>
<p class="p">First define the <span class="code">map</span> and <span class="code">reduce</span> functions:</p>
<div class="code"><pre class="contents syntax brush-clang">const char* const COLLECTION_NAME = "things";

/* Our map function just emits a single (key, 1) pair for each tag
   in the array: */
const char* const MAPPER =
   "function () {"
      "this.tags.forEach(function(z) {"
         "emit(z, 1);"
      "});"
   "}";

/* The reduce function sums over all of the emitted values for a
   given key: */
const char* const REDUCER =
   "function (key, values) {"
      "var total = 0;"
      "for (var i = 0; i &lt; values.length; i++) {"
         "total += values[i];"
      "}"
      "return total;"
   "}";
/* Note We canâ€™t just return values.length as the reduce function
   might be called iteratively on the results of other reduce
   steps. */</pre></div>
<p class="p">Run the <span class="code">mapReduce</span> command:</p>
<div class="code"><pre class="contents syntax brush-clang">bool map_reduce_basic (mongoc_database_t* database)
{
   bson_t reply;
   bson_t* command;
   bool res;
   bson_error_t error;
   mongoc_cursor_t* cursor;
   const bson_t* doc;

   bool map_reduce_done = false;
   bool query_done = false;

   const char* out_collection_name = "outCollection";
   mongoc_collection_t* out_collection;

   /* Empty find query */
   bson_t find_query = BSON_INITIALIZER;

   /* Construct the mapReduce command */

   /* Other arguments can also be specified here, like "query" or
      "limit" and so on */
   command = BCON_NEW ("mapReduce", BCON_UTF8 (COLLECTION_NAME),
                       "map", BCON_CODE (MAPPER),
                       "reduce", BCON_CODE (REDUCER),
                       "out", BCON_UTF8 (out_collection_name));
   res = mongoc_database_command_simple (database, command, NULL,
                                        &amp;reply, &amp;error);
   map_reduce_done = true;

   if (!res) {
      fprintf (stderr, "MapReduce failed: %s\n", error.message);
      goto cleanup;
   }

   /* Do something with the reply (it doesn't contain the mapReduce results) */
   print_res (&amp;reply);

   /* Now we'll query outCollection to see what the results are */
   out_collection = mongoc_database_get_collection (database,
                                                    out_collection_name);
   cursor = mongoc_collection_find (out_collection, MONGOC_QUERY_NONE, 0, 0, 0,
                                    &amp;find_query, NULL, NULL);
   query_done = true;

   /* Do something with the results */
   while (mongoc_cursor_next (cursor, &amp;doc)) {
      print_res (doc);
   }

   if (mongoc_cursor_error (cursor, &amp;error)) {
      fprintf (stderr, "ERROR: %s\n", error.message);
      res = false;
      goto cleanup;
   }

cleanup:
   /* cleanup */
   if (query_done) {
      mongoc_cursor_destroy (cursor);
      mongoc_collection_destroy (out_collection);
   }

   if (map_reduce_done) {
      bson_destroy (&amp;reply);
      bson_destroy (command);
   }

   return res;
}</pre></div>
</div></div>
</div></div>
<div id="map-reduce-advanced" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">"mapReduce" - more complicated example</span></h2></div>
<div class="region"><div class="contents">
<p class="p">You must have replica set running for this.</p>
<p class="p">In this example we contact a secondary in the replica set and do an "inline" map reduce, so the results are returned immediately:</p>
<div class="code"><pre class="contents syntax brush-clang">bool map_reduce_advanced (mongoc_database_t* database)
{
   bson_t* command;
   bson_error_t error;
   bool res = true;
   mongoc_cursor_t* cursor;
   mongoc_read_prefs_t* read_pref;
   const bson_t* doc;

   /* Construct the mapReduce command */
   /* Other arguments can also be specified here, like "query" or "limit"
      and so on */

   /* Read the results inline from a secondary replica */
   command = BCON_NEW ("mapReduce", BCON_UTF8 (COLLECTION_NAME),
                       "map", BCON_CODE (MAPPER),
                       "reduce", BCON_CODE (REDUCER),
                       "out", "{", "inline", "1", "}");

   read_pref = mongoc_read_prefs_new (MONGOC_READ_SECONDARY);
   cursor = mongoc_database_command (database, MONGOC_QUERY_NONE, 0, 0, 0,
                                     command, NULL, read_pref);

   /* Do something with the results */
   while (mongoc_cursor_next (cursor, &amp;doc)) {
      print_res (doc);
   }

   if (mongoc_cursor_error (cursor, &amp;error)) {
      fprintf (stderr, "ERROR: %s\n", error.message);
      res = false;
   }

   mongoc_cursor_destroy (cursor);
   mongoc_read_prefs_destroy (read_pref);
   bson_destroy (command);

   return res;
}</pre></div>
</div></div>
</div></div>
<div id="running" class="sect"><div class="inner">
<div class="hgroup"><h2 class="title"><span class="title">Running</span></h2></div>
<div class="region"><div class="contents">
<p class="p">Here's how to run the example code</p>
<div class="listing"><div class="inner">
<div class="title title-listing"><h3><span class="title">basic-aggregation.c</span></h3></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents syntax brush-clang">/*
 * Copyright 2016 MongoDB, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


#include &lt;mongoc.h&gt;
#include &lt;stdio.h&gt;


#include "constants.c"

#include "../doc-common-insert.c"
#include "distinct.c"
#include "map-reduce-basic.c"
#include "map-reduce-advanced.c"


int
main (int   argc,
      char *argv[])
{
   mongoc_database_t *database = NULL;
   mongoc_client_t *client = NULL;
   mongoc_collection_t *collection = NULL;
   char *host_and_port = NULL;
   int res = 0;

   if (argc != 2) {
      fprintf (stderr, "usage: %s CONNECTION-STRING\n",
               argv[0]);
      fprintf (stderr,
               "the connection string can be of the following forms:\n");
      fprintf (stderr, "localhost\t\t\t\tlocal machine\n");
      fprintf (stderr, "localhost:27018\t\t\t\tlocal machine on port 27018\n");
      fprintf (stderr,
               "mongodb://user:pass@localhost:27017\t"
               "local machine on port 27017, and authenticate with username "
               "user and password pass\n");
      return 1;
   }

   mongoc_init ();

   if (strncmp (argv[1], "mongodb://", 10) == 0) {
      host_and_port = bson_strdup (argv [1]);
   } else {
      host_and_port = bson_strdup_printf ("mongodb://%s", argv[1]);
   }

   client = mongoc_client_new (host_and_port);

   if (!client) {
      fprintf (stderr, "Invalid hostname or port: %s\n", host_and_port);
      res = 2;
      goto cleanup;
   }

   mongoc_client_set_error_api (client, 2);
   database = mongoc_client_get_database (client, "test");
   collection = mongoc_database_get_collection (database, COLLECTION_NAME);

   printf ("Inserting data\n");
   if (!insert_data (collection)) {
      res = 3;
      goto cleanup;
   }

   printf ("distinct\n");
   if (!distinct (database)) {
      res = 4;
      goto cleanup;
   }

   printf ("map reduce\n");
   if (!map_reduce_basic (database)) {
      res = 5;
      goto cleanup;
   }

   printf ("more complicated map reduce\n");
   if (!map_reduce_advanced (database)) {
      res = 6;
      goto cleanup;
   }

cleanup:
   if (collection) {
      mongoc_collection_destroy (collection);
   }

   if (database) {
      mongoc_database_destroy (database);
   }

   if (client) {
      mongoc_client_destroy (client);
   }

   if (host_and_port) {
      bson_free (host_and_port);
   }

   mongoc_cleanup ();
   return res;
}</pre></div></div></div>
</div></div>
<p class="p">If you want to try the advanced map reduce example with a secondary, start a replica set (instructions for how to do this can be found <span class="link"><a href="https://docs.mongodb.com/manual/tutorial/deploy-replica-set-for-testing/" title="https://docs.mongodb.com/manual/tutorial/deploy-replica-set-for-testing/">here</a></span>).</p>
<p class="p">Otherwise, just start an instance of MongoDB:</p>
<div class="screen"><pre class="contents "><span class="prompt output">$ </span><span class="input">mongod</span></pre></div>
<p class="p">Now compile and run the example program:</p>
<div class="screen"><pre class="contents "><span class="prompt output">$ </span><span class="input">cd examples/basic_aggregation/</span>
<span class="prompt output">$ </span><span class="input">gcc -Wall -o agg-example basic-aggregation.c $(pkg-config --cflags --libs libmongoc-1.0)</span>
<span class="prompt output">$ </span><span class="input">./agg-example localhost</span>
Inserting data
distinct
Next double: 2.000000
Next double: 3.000000
map reduce
{ "result" : "outCollection", "timeMillis" : 155, "counts" : { "input" : 84, "emit" : 126, "reduce" : 3, "output" : 3 }, "ok" : 1 }
{ "_id" : "cat", "value" : 63 }
{ "_id" : "dog", "value" : 42 }
{ "_id" : "mouse", "value" : 21 }
more complicated map reduce
{ "results" : [ { "_id" : "cat", "value" : 63 }, { "_id" : "dog", "value" : 42 }, { "_id" : "mouse", "value" : 21 } ], "timeMillis" : 14, "counts" : { "input" : 84, "emit" : 126, "reduce" : 3, "output" : 3 }, "ok" : 1 }</pre></div>
</div></div>
</div></div>
</div>
<div class="clear"></div>
</div>
<div class="footer"></div>
</div></body>
</html>
