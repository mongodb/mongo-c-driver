
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7301842-14"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-7301842-14');
</script>
<link rel="canonical" href="https://www.mongoc.org/libmongoc/current/client-side-field-level-encryption.html"/>
    <title>Client-Side Field Level Encryption &#8212; libmongoc 1.24.1</title>
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sphinx_highlight.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Queryable Encryption" href="queryable-encryption.html" />
    <link rel="prev" title="In-Use Encryption" href="in-use-encryption.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
<div style="text-align: center; border: 1px solid gray; padding: 10px; background: #d4f1ff">
  This is an outdated version of the documentation.
  <a href="http://mongoc.org/libmongoc/current/client-side-field-level-encryption.html"
     style="color: black; font-weight: bold; text-decoration: underline;">
    See the current version of this page</a>.
</div>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="queryable-encryption.html" title="Queryable Encryption"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="in-use-encryption.html" title="In-Use Encryption"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">libmongoc 1.24.1</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="guides.html" >Guides</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="in-use-encryption.html" accesskey="U">In-Use Encryption</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="client-side-field-level-encryption">
<h1>Client-Side Field Level Encryption<a class="headerlink" href="#client-side-field-level-encryption" title="Permalink to this heading">¶</a></h1>
<p>New in MongoDB 4.2, Client-Side Field Level Encryption (also referred to as CSFLE) allows administrators and developers to encrypt specific data fields in addition to other MongoDB encryption features.</p>
<p>With CSFLE, developers can encrypt fields client side without any server-side configuration or directives. CSFLE supports workloads where applications must guarantee that unauthorized parties, including server administrators, cannot read the encrypted data.</p>
<p>Automatic encryption, where sensitive fields in commands are encrypted automatically, requires an Enterprise-only dependency for Query Analysis. See <a class="reference internal" href="in-use-encryption.html"><span class="doc">In-Use Encryption</span></a> for more information.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<div class="line-block">
<div class="line">The MongoDB Manual for <a class="reference external" href="https://www.mongodb.com/docs/manual/core/security-client-side-encryption/">Client-Side Field Level Encryption</a></div>
</div>
</div>
<section id="automatic-client-side-field-level-encryption">
<h2>Automatic Client-Side Field Level Encryption<a class="headerlink" href="#automatic-client-side-field-level-encryption" title="Permalink to this heading">¶</a></h2>
<p>Automatic encryption is enabled by calling <a class="symbol reference internal" href="mongoc_client_enable_auto_encryption.html"><span class="doc">mongoc_client_enable_auto_encryption()</span></a> on a <a class="symbol reference internal" href="mongoc_client_t.html"><span class="doc">mongoc_client_t</span></a>. The following examples show how to set up automatic encryption using <a class="symbol reference internal" href="mongoc_client_encryption_t.html"><span class="doc">mongoc_client_encryption_t</span></a> to create a new encryption data key.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Automatic encryption requires MongoDB 4.2 enterprise or a MongoDB 4.2 Atlas cluster. The community version of the server supports automatic decryption as well as <a class="reference internal" href="#explicit-client-side-encryption"><span class="std std-ref">Explicit Encryption</span></a>.</p>
</div>
<section id="providing-local-automatic-encryption-rules">
<h3>Providing Local Automatic Encryption Rules<a class="headerlink" href="#providing-local-automatic-encryption-rules" title="Permalink to this heading">¶</a></h3>
<p>The following example shows how to specify automatic encryption rules using a schema map set with <a class="symbol reference internal" href="mongoc_auto_encryption_opts_set_schema_map.html"><span class="doc">mongoc_auto_encryption_opts_set_schema_map()</span></a>. The automatic encryption rules are expressed using a strict subset of the JSON Schema syntax.</p>
<p>Supplying a schema map provides more security than relying on JSON Schemas obtained from the server. It protects against a malicious server advertising a false JSON Schema, which could trick the client into sending unencrypted data that should be encrypted.</p>
<p>JSON Schemas supplied in the schema map only apply to configuring automatic encryption. Other validation rules in the JSON schema will not be enforced by the driver and will result in an error:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-schema-map.c</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mongoc/mongoc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span>

<span class="cm">/* Helper method to create a new data key in the key vault, a schema to use that</span>
<span class="cm"> * key, and writes the schema to a file for later use. */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span>
<span class="nf">create_schema_file</span><span class="w"> </span><span class="p">(</span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">kms_providers</span><span class="p">,</span>
<span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_db</span><span class="p">,</span>
<span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_coll</span><span class="p">,</span>
<span class="w">                    </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_client</span><span class="p">,</span>
<span class="w">                    </span><span class="n">bson_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">datakey_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;mongoc_encryption_example_1&quot;</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">schema_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">schema_string_len</span><span class="p">;</span>
<span class="w">   </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">outfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">   </span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">keyvault_db</span><span class="p">,</span><span class="w"> </span><span class="n">keyvault_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_client</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">keyvault_client</span><span class="p">);</span>

<span class="w">   </span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_encryption_new</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a new data key and json schema for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_datakey_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="n">keyaltnames</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mongoc_client_encryption_create_datakey</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;local&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a schema describing that &quot;encryptedField&quot; is a string encrypted</span>
<span class="cm">    * with the newly created data key using deterministic encryption. */</span>
<span class="w">   </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;properties&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;encrypt&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;keyId&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;[&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="n">BCON_BIN</span><span class="w"> </span><span class="p">(</span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">subtype</span><span class="p">,</span>
<span class="w">                                </span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
<span class="w">                                </span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data_len</span><span class="p">),</span>
<span class="w">                      </span><span class="s">&quot;]&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;string&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;algorithm&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;object&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Use canonical JSON so that other drivers and tools will be</span>
<span class="cm">    * able to parse the MongoDB extended JSON file. */</span>
<span class="w">   </span><span class="n">schema_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bson_as_canonical_extended_json</span><span class="w"> </span><span class="p">(</span><span class="n">schema</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">schema_string_len</span><span class="p">);</span>
<span class="w">   </span><span class="n">outfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;jsonSchema.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">fwrite</span><span class="w"> </span><span class="p">(</span><span class="n">schema_string</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"> </span><span class="n">schema_string_len</span><span class="p">,</span><span class="w"> </span><span class="n">outfile</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;failed to write to file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_free</span><span class="w"> </span><span class="p">(</span><span class="n">schema_string</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">schema</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fclose</span><span class="w"> </span><span class="p">(</span><span class="n">outfile</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This example demonstrates how to use automatic encryption with a client-side</span>
<span class="cm"> * schema map using the enterprise version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_error_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_index_model_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_json_reader_t</span><span class="w"> </span><span class="o">*</span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BSON_INITIALIZER</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">schema_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">   </span><span class="cm">/* The MongoClient used to access the key vault (keyvault_namespace). */</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">auto_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">unencrypted_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">unencrypted_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">   </span><span class="n">mongoc_init</span><span class="w"> </span><span class="p">();</span>

<span class="w">   </span><span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create the encryption key. */</span>
<span class="w">   </span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">hex_to_bin</span><span class="w"> </span><span class="p">(</span><span class="n">getenv</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">96</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<span class="w">               </span><span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
<span class="w">               </span><span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;key&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="n">BCON_BIN</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">),</span>
<span class="w">                             </span><span class="s">&quot;}&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Set up the key vault for this example. */</span>
<span class="w">   </span><span class="n">keyvault_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-keyvault&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_client</span><span class="p">);</span>

<span class="w">   </span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">keyvault_client</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
<span class="w">   </span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BCON_INT32</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">   </span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;unique&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;$exists&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_index_model_new</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">,</span><span class="w"> </span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_create_indexes_with_opts</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">index_model</span><span class="p">,</span>
<span class="w">                                                     </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a new data key and a schema using it for encryption. Save the</span>
<span class="cm">    * schema to the file jsonSchema.json */</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_schema_file</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">kms_providers</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">,</span><span class="w"> </span><span class="n">keyvault_client</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Load the JSON Schema and construct the local schema_map option. */</span>
<span class="w">   </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bson_json_reader_new_from_file</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;jsonSchema.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">bson_json_reader_read</span><span class="w"> </span><span class="p">(</span><span class="n">reader</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">schema</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Construct the schema map, mapping the namespace of the collection to the</span>
<span class="cm">    * schema describing encryption. */</span>
<span class="w">   </span><span class="n">schema_map</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="n">ENCRYPTED_DB</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">,</span><span class="w"> </span><span class="n">BCON_DOCUMENT</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema</span><span class="p">));</span>

<span class="w">   </span><span class="n">auto_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_auto_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_keyvault_client</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">keyvault_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">auto_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_schema_map</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                               </span><span class="n">schema_map</span><span class="p">);</span>

<span class="w">   </span><span class="n">client</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Enable automatic encryption. It will determine that encryption is</span>
<span class="cm">    * necessary from the schema map instead of relying on the server to provide</span>
<span class="cm">    * a schema. */</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_enable_auto_encryption</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">auto_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Clear old data */</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123456789&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_insert_one</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;decrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">unencrypted_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-unencrypted&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>

<span class="w">   </span><span class="n">unencrypted_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">unencrypted_client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">bson_free</span><span class="w"> </span><span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_index_model_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_model</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_json_reader_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">schema_map</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_cleanup</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="server-side-field-level-encryption-enforcement">
<h3>Server-Side Field Level Encryption Enforcement<a class="headerlink" href="#server-side-field-level-encryption-enforcement" title="Permalink to this heading">¶</a></h3>
<p>The MongoDB 4.2 server supports using schema validation to enforce encryption of specific fields in a collection. This schema validation will prevent an application from inserting unencrypted values for any fields marked with the “encrypt” JSON schema keyword.</p>
<p>The following example shows how to set up automatic encryption using <a class="symbol reference internal" href="mongoc_client_encryption_t.html"><span class="doc">mongoc_client_encryption_t</span></a> to create a new encryption data key and create a collection with the necessary JSON Schema:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-server-schema.c</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mongoc/mongoc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span>

<span class="cm">/* Helper method to create and return a JSON schema to use for encryption.</span>
<span class="cm">The caller will use the returned schema for server-side encryption validation.</span>
<span class="cm">*/</span>
<span class="k">static</span><span class="w"> </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span>
<span class="nf">create_schema</span><span class="w"> </span><span class="p">(</span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">kms_providers</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_db</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_coll</span><span class="p">,</span>
<span class="w">               </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_client</span><span class="p">,</span>
<span class="w">               </span><span class="n">bson_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">datakey_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;mongoc_encryption_example_2&quot;</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">   </span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">keyvault_db</span><span class="p">,</span><span class="w"> </span><span class="n">keyvault_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_client</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">keyvault_client</span><span class="p">);</span>

<span class="w">   </span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_encryption_new</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a new data key and json schema for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_datakey_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="n">keyaltnames</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mongoc_client_encryption_create_datakey</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;local&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a schema describing that &quot;encryptedField&quot; is a string encrypted</span>
<span class="cm">    * with the newly created data key using deterministic encryption. */</span>
<span class="w">   </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;properties&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;encrypt&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;keyId&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;[&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="n">BCON_BIN</span><span class="w"> </span><span class="p">(</span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">subtype</span><span class="p">,</span>
<span class="w">                                </span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
<span class="w">                                </span><span class="n">datakey_id</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_binary</span><span class="p">.</span><span class="n">data_len</span><span class="p">),</span>
<span class="w">                      </span><span class="s">&quot;]&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;string&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;algorithm&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;bsonType&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;object&quot;</span><span class="p">);</span>

<span class="nl">fail</span><span class="p">:</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">schema</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This example demonstrates how to use automatic encryption with a server-side</span>
<span class="cm"> * schema using the enterprise version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_error_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_index_model_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_json_reader_t</span><span class="w"> </span><span class="o">*</span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">   </span><span class="cm">/* The MongoClient used to access the key vault (keyvault_namespace). */</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">auto_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">unencrypted_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">unencrypted_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">create_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">create_cmd_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_write_concern_t</span><span class="w"> </span><span class="o">*</span><span class="n">wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">   </span><span class="n">mongoc_init</span><span class="w"> </span><span class="p">();</span>

<span class="w">   </span><span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create</span>
<span class="cm">    * the encryption key. */</span>
<span class="w">   </span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">hex_to_bin</span><span class="w"> </span><span class="p">(</span><span class="n">getenv</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">96</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<span class="w">               </span><span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
<span class="w">               </span><span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;key&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="n">BCON_BIN</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">),</span>
<span class="w">                             </span><span class="s">&quot;}&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Set up the key vault for this example. */</span>
<span class="w">   </span><span class="n">keyvault_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-keyvault&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_client</span><span class="p">);</span>

<span class="w">   </span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">keyvault_client</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
<span class="w">   </span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BCON_INT32</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">   </span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;unique&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;$exists&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_index_model_new</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">,</span><span class="w"> </span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_create_indexes_with_opts</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">index_model</span><span class="p">,</span>
<span class="w">                                                     </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">auto_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_auto_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_keyvault_client</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">keyvault_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">auto_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_schema</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">kms_providers</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">,</span><span class="w"> </span><span class="n">keyvault_client</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">schema</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">client</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_enable_auto_encryption</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">auto_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Clear old data */</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Create the collection with the encryption JSON Schema. */</span>
<span class="w">   </span><span class="n">create_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">ENCRYPTED_COLL</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;validator&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;$jsonSchema&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_DOCUMENT</span><span class="w"> </span><span class="p">(</span><span class="n">schema</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_write_concern_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_write_concern_set_wmajority</span><span class="w"> </span><span class="p">(</span><span class="n">wc</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">   </span><span class="n">create_cmd_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bson_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_write_concern_append</span><span class="w"> </span><span class="p">(</span><span class="n">wc</span><span class="p">,</span><span class="w"> </span><span class="n">create_cmd_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_command_with_opts</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">create_cmd</span><span class="p">,</span>
<span class="w">                                          </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* read prefs */</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">create_cmd_opts</span><span class="p">,</span>
<span class="w">                                          </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span>
<span class="w">                                          </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123456789&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_insert_one</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;decrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">unencrypted_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption-unencrypted&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>

<span class="w">   </span><span class="n">unencrypted_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">unencrypted_client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Expect a server-side error if inserting with the unencrypted collection.</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_insert_one</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">unencrypted_coll</span><span class="p">,</span><span class="w"> </span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;insert with unencrypted collection failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
<span class="w">      </span><span class="n">memset</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">bson_free</span><span class="w"> </span><span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_index_model_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_model</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_json_reader_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">reader</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">schema</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">create_cmd</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">create_cmd_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_write_concern_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>

<span class="w">   </span><span class="n">mongoc_cleanup</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="explicit-encryption">
<span id="explicit-client-side-encryption"></span><h3>Explicit Encryption<a class="headerlink" href="#explicit-encryption" title="Permalink to this heading">¶</a></h3>
<p>Explicit encryption is a MongoDB community feature and does not use <a class="reference internal" href="in-use-encryption.html#query-analysis"><span class="std std-ref">Query Analysis</span></a> (<code class="docutils literal notranslate"><span class="pre">mongocryptd</span></code> or <code class="docutils literal notranslate"><span class="pre">crypt_shared</span></code>). Explicit encryption is provided by the <a class="symbol reference internal" href="mongoc_client_encryption_t.html"><span class="doc">mongoc_client_encryption_t</span></a> class, for example:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-explicit.c</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mongoc/mongoc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span>

<span class="cm">/* This example demonstrates how to use explicit encryption and decryption using</span>
<span class="cm"> * the community version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_error_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_index_model_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">create_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">create_cmd_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_write_concern_t</span><span class="w"> </span><span class="o">*</span><span class="n">wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;mongoc_encryption_example_3&quot;</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">datakey_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">encrypted_field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">to_encrypt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">encrypt_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">decrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="w">   </span><span class="n">mongoc_init</span><span class="w"> </span><span class="p">();</span>

<span class="w">   </span><span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create the encryption key. */</span>
<span class="w">   </span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">hex_to_bin</span><span class="w"> </span><span class="p">(</span><span class="n">getenv</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">96</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<span class="w">               </span><span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
<span class="w">               </span><span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;key&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="n">BCON_BIN</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">),</span>
<span class="w">                             </span><span class="s">&quot;}&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* The mongoc_client_t used to read/write application data. */</span>
<span class="w">   </span><span class="n">client</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Clear old data */</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Set up the key vault for this example. */</span>
<span class="w">   </span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
<span class="w">   </span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BCON_INT32</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">   </span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;unique&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;$exists&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_index_model_new</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">,</span><span class="w"> </span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_create_indexes_with_opts</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">index_model</span><span class="p">,</span>
<span class="w">                                                     </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Set a mongoc_client_t to use for reading/writing to the key vault. This</span>
<span class="cm">    * can be the same mongoc_client_t used by the main application. */</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_client</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">client</span><span class="p">);</span>
<span class="w">   </span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_encryption_new</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a new data key for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_datakey_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="n">keyaltnames</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mongoc_client_encryption_create_datakey</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;local&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Explicitly encrypt a field */</span>
<span class="w">   </span><span class="n">encrypt_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_encrypt_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_set_algorithm</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">encrypt_opts</span><span class="p">,</span><span class="w"> </span><span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_set_keyid</span><span class="w"> </span><span class="p">(</span><span class="n">encrypt_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
<span class="w">   </span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BSON_TYPE_UTF8</span><span class="p">;</span>
<span class="w">   </span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;123456789&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="w"> </span><span class="p">(</span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">bson_in_range_unsigned</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">));</span>
<span class="w">   </span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_encrypt</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to_encrypt</span><span class="p">,</span><span class="w"> </span><span class="n">encrypt_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bson_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">BSON_APPEND_VALUE</span><span class="w"> </span><span class="p">(</span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_insert_one</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Explicitly decrypt a field */</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_decrypt</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decrypted</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;decrypted value: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decrypted</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>

<span class="w">   </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">bson_free</span><span class="w"> </span><span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_index_model_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_model</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">schema</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">create_cmd</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">create_cmd_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_write_concern_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">encrypt_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">decrypted</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>

<span class="w">   </span><span class="n">mongoc_cleanup</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="explicit-encryption-with-automatic-decryption">
<h3>Explicit Encryption with Automatic Decryption<a class="headerlink" href="#explicit-encryption-with-automatic-decryption" title="Permalink to this heading">¶</a></h3>
<p>Although automatic encryption requires MongoDB 4.2 enterprise or a MongoDB 4.2 Atlas cluster, automatic decryption is supported for all users. To configure automatic decryption without automatic encryption set bypass_auto_encryption=True in <a class="symbol reference internal" href="mongoc_auto_encryption_opts_t.html"><span class="doc">mongoc_auto_encryption_opts_t</span></a>:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">client-side-encryption-auto-decryption.c</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mongoc/mongoc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;client-side-encryption-helpers.h&quot;</span>

<span class="cm">/* This example demonstrates how to set up automatic decryption without</span>
<span class="cm"> * automatic encryption using the community version of MongoDB */</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* The collection used to store the encryption data keys. */</span>
<span class="cp">#define KEYVAULT_DB &quot;encryption&quot;</span>
<span class="cp">#define KEYVAULT_COLL &quot;__libmongocTestKeyVault&quot;</span>
<span class="cm">/* The collection used to store the encrypted documents in this example. */</span>
<span class="cp">#define ENCRYPTED_DB &quot;test&quot;</span>
<span class="cp">#define ENCRYPTED_COLL &quot;coll&quot;</span>

<span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_error_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_index_model_t</span><span class="w"> </span><span class="o">*</span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">create_cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_t</span><span class="w"> </span><span class="o">*</span><span class="n">create_cmd_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_write_concern_t</span><span class="w"> </span><span class="o">*</span><span class="n">wc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">keyaltnames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;mongoc_encryption_example_4&quot;</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">datakey_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">encrypted_field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">to_encrypt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">encrypt_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">bson_value_t</span><span class="w"> </span><span class="n">decrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_t</span><span class="w"> </span><span class="o">*</span><span class="n">auto_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_client_t</span><span class="w"> </span><span class="o">*</span><span class="n">unencrypted_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">   </span><span class="n">mongoc_collection_t</span><span class="w"> </span><span class="o">*</span><span class="n">unencrypted_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">   </span><span class="n">mongoc_init</span><span class="w"> </span><span class="p">();</span>

<span class="w">   </span><span class="cm">/* Configure the master key. This must be the same master key that was used</span>
<span class="cm">    * to create the encryption key. */</span>
<span class="w">   </span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">hex_to_bin</span><span class="w"> </span><span class="p">(</span><span class="n">getenv</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;LOCAL_MASTERKEY&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_masterkey_len</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">local_masterkey</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">96</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<span class="w">               </span><span class="s">&quot;Specify LOCAL_MASTERKEY environment variable as a &quot;</span>
<span class="w">               </span><span class="s">&quot;secure random 96 byte hex value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">kms_providers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="s">&quot;key&quot;</span><span class="p">,</span>
<span class="w">                             </span><span class="n">BCON_BIN</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey</span><span class="p">,</span><span class="w"> </span><span class="n">local_masterkey_len</span><span class="p">),</span>
<span class="w">                             </span><span class="s">&quot;}&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">client</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">auto_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_auto_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">auto_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">kms_providers</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Setting bypass_auto_encryption to true disables automatic encryption but</span>
<span class="cm">    * keeps the automatic decryption behavior. bypass_auto_encryption will also</span>
<span class="cm">    * disable spawning mongocryptd */</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_set_bypass_auto_encryption</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">,</span>
<span class="w">                                                           </span><span class="nb">true</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Once bypass_auto_encryption is set, community users can enable auto</span>
<span class="cm">    * encryption on the client. This will, in fact, only perform automatic</span>
<span class="cm">    * decryption. */</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_enable_auto_encryption</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">auto_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Now that automatic decryption is on, we can test it by inserting a</span>
<span class="cm">    * document with an explicitly encrypted value into the collection. When we</span>
<span class="cm">    * look up the document later, it should be automatically decrypted for us.</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="n">coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Clear old data */</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Set up the key vault for this example. */</span>
<span class="w">   </span><span class="n">keyvault_coll</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_drop</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* Create a unique index to ensure that two data keys cannot share the same</span>
<span class="cm">    * keyAltName. This is recommended practice for the key vault. */</span>
<span class="w">   </span><span class="n">index_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BCON_INT32</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="w">   </span><span class="n">index_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCON_NEW</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;unique&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;partialFilterExpression&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;keyAltNames&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;{&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;$exists&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="n">BCON_BOOL</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">),</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">,</span>
<span class="w">                          </span><span class="s">&quot;}&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">index_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_index_model_new</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">,</span><span class="w"> </span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_create_indexes_with_opts</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">index_model</span><span class="p">,</span>
<span class="w">                                                     </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">client_encryption_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_kms_providers</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_namespace</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_DB</span><span class="p">,</span><span class="w"> </span><span class="n">KEYVAULT_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/* The key vault client is used for reading to/from the key vault. This can</span>
<span class="cm">    * be the same mongoc_client_t used by the application. */</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_set_keyvault_client</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">client</span><span class="p">);</span>
<span class="w">   </span><span class="n">client_encryption</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_encryption_new</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client_encryption</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Create a new data key for the encryptedField.</span>
<span class="cm">    * https://dochub.mongodb.org/core/client-side-field-level-encryption-automatic-encryption-rules</span>
<span class="cm">    */</span>
<span class="w">   </span><span class="n">datakey_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_datakey_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_set_keyaltnames</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="n">keyaltnames</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_create_datakey</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;local&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datakey_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* Explicitly encrypt a field. */</span>
<span class="w">   </span><span class="n">encrypt_opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_encrypt_opts_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_set_algorithm</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">encrypt_opts</span><span class="p">,</span><span class="w"> </span><span class="n">MONGOC_AEAD_AES_256_CBC_HMAC_SHA_512_DETERMINISTIC</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_set_keyaltname</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">encrypt_opts</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mongoc_encryption_example_4&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BSON_TYPE_UTF8</span><span class="p">;</span>
<span class="w">   </span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;123456789&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="w"> </span><span class="p">(</span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
<span class="w">   </span><span class="n">BSON_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">bson_in_range_unsigned</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">));</span>
<span class="w">   </span><span class="n">to_encrypt</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">v_utf8</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_encryption_encrypt</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">client_encryption</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to_encrypt</span><span class="p">,</span><span class="w"> </span><span class="n">encrypt_opts</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">to_insert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bson_new</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="n">BSON_APPEND_VALUE</span><span class="w"> </span><span class="p">(</span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;encryptedField&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
<span class="w">   </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_collection_insert_one</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="n">to_insert</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* opts */</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="cm">/* reply */</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="cm">/* When we retrieve the document, any encrypted fields will get automatically</span>
<span class="cm">    * decrypted by the driver. */</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;decrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">unencrypted_client</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">mongoc_client_new</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;mongodb://localhost/?appname=client-side-encryption&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">unencrypted_coll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoc_client_get_collection</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="n">unencrypted_client</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_DB</span><span class="p">,</span><span class="w"> </span><span class="n">ENCRYPTED_COLL</span><span class="p">);</span>

<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;encrypted document: &quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">print_one_document</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="n">exit_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="nl">fail</span><span class="p">:</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">fprintf</span><span class="w"> </span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">bson_free</span><span class="w"> </span><span class="p">(</span><span class="n">local_masterkey</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">kms_providers</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">keyvault_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_index_model_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_model</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">index_keys</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">to_insert</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">schema</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">create_cmd</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">create_cmd_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_write_concern_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_datakey_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">datakey_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">client_encryption_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">encrypted_field</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_encryption_encrypt_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">encrypt_opts</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">decrypted</span><span class="p">);</span>
<span class="w">   </span><span class="n">bson_value_destroy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">datakey_id</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_collection_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_coll</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_client_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">unencrypted_client</span><span class="p">);</span>
<span class="w">   </span><span class="n">mongoc_auto_encryption_opts_destroy</span><span class="w"> </span><span class="p">(</span><span class="n">auto_encryption_opts</span><span class="p">);</span>

<span class="w">   </span><span class="n">mongoc_cleanup</span><span class="w"> </span><span class="p">();</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">exit_status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing the MongoDB C Driver (libmongoc) and BSON library (libbson)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic-troubleshooting.html">Basic Troubleshooting</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="guides.html">Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="configuring_tls.html">Configuring TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoc-common-task-examples.html">Common Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-connections.html">Advanced Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection-pooling.html">Connection Pooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="cursors.html">Cursors</a></li>
<li class="toctree-l2"><a class="reference internal" href="bulk.html">Bulk Write Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="aggregate.html">Aggregation Framework Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="distinct-mapreduce.html">“distinct” and “mapReduce”</a></li>
<li class="toctree-l2"><a class="reference internal" href="visual-studio-guide.html">Using libmongoc in a Microsoft Visual Studio project</a></li>
<li class="toctree-l2"><a class="reference internal" href="manage-collection-indexes.html">Manage Collection Indexes</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Aids for Debugging</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="in-use-encryption.html">In-Use Encryption</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="application-performance-monitoring.html">Application Performance Monitoring (APM)</a></li>
</ul>
<!-- Because full_index.rst includes everything that index.rst includes, we have to exclude index.rst from the table-of-contents. This page is simply a link forced into the sidebar (in conf.py) to avoid including full_index.rst in the ToC. -->
<ul><li class='toctree-l1'><a href="full_index.html">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2017-present, MongoDB, Inc.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.
  </div>
  
  </body>
</html>