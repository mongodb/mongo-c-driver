<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Common Tasks</title>
<link rel="stylesheet" type="text/css" href="C.css">
<script type="text/javascript" src="jquery.js"></script><script type="text/javascript" src="jquery.syntax.js"></script><script type="text/javascript" src="yelp.js"></script>
</head>
<body><div class="page" role="main">
<div class="header"><div class="trails" role="navigation"><div class="trail">
<a class="trail" href="index.html" title="MongoDB C Driver">MongoDB C Driver</a> › <a class="trail" href="index.html#basic-operations" title="Basic Operations">Basic Operations</a> » </div></div></div>
<div class="body">
<div class="hgroup"><h1 class="title"><span class="title">Common Tasks</span></h1></div>
<div class="region">
<div class="contents"></div>
<div id="common-tasks" class="sect"><div class="inner">
<div class="hgroup"></div>
<div class="region">
<div class="contents">
<p class="p">Drivers for some other languages provide helper functions to perform certain common tasks. In the C Driver we must explicitly build commands to send to the server.</p>
<p class="p">This snippet contains example code for the <span class="code">explain</span>, <span class="code">copydb</span> and <span class="code">cloneCollection</span> commands.</p>
</div>
<div id="setup" class="sect"><div class="inner">
<div class="hgroup"><h3 class="title"><span class="title">Setup</span></h3></div>
<div class="region"><div class="contents">
<p class="p">First we'll write some code to insert sample data:</p>
<div class="code"><pre class="contents syntax brush-clang">/* Don't try to compile this file on it's own. It's meant to be #included
   by example code */

/* Insert some sample data */
bool insert_data (mongoc_collection_t* collection)
{
   mongoc_bulk_operation_t *bulk;
   enum N { ndocs = 4 };
   bson_t* docs[ndocs];
   bson_error_t error;
   int i = 0;
   bool ret;

   bulk = mongoc_collection_create_bulk_operation (collection, true, NULL);

   docs[0] = BCON_NEW ("x", BCON_DOUBLE (1.0), "tags", "[", "dog", "cat", "]");
   docs[1] = BCON_NEW ("x", BCON_DOUBLE (2.0), "tags", "[", "cat", "]");
   docs[2] = BCON_NEW ("x", BCON_DOUBLE (2.0), "tags",
                       "[", "mouse", "cat", "dog", "]");
   docs[3] = BCON_NEW ("x", BCON_DOUBLE (3.0), "tags", "[", "]");

   for (i = 0; i &lt; ndocs; i++) {
      mongoc_bulk_operation_insert (bulk, docs[i]);
      bson_destroy (docs[i]);
      docs[i] = NULL;
   }

   ret = mongoc_bulk_operation_execute (bulk, NULL, &amp;error);

   if (!ret) {
      fprintf (stderr, "Error inserting data: %s\n", error.message);
   }

   mongoc_bulk_operation_destroy (bulk);
   return ret;
}

/* A helper which we'll use a lot later on */
void print_res (const bson_t* reply)
{
   BSON_ASSERT (reply);
   char *str = bson_as_json (reply, NULL);
   printf ("%s\n", str);
   bson_free (str);
}</pre></div>
</div></div>
</div></div>
<div id="explain" class="sect"><div class="inner">
<div class="hgroup"><h3 class="title"><span class="title">"explain" Command</span></h3></div>
<div class="region"><div class="contents">
<p class="p">This is how to use the <span class="code">explain</span> command in MongoDB 3.2+:</p>
<div class="code"><pre class="contents syntax brush-clang">bool explain (mongoc_collection_t* collection)
{
   bson_t* command;
   bson_t reply;
   bson_error_t error;
   bool res;

   command = BCON_NEW ("explain", "{",
                       "find", BCON_UTF8 (COLLECTION_NAME),
                       "filter", "{", "x", BCON_INT32 (1), "}",
                       "}");
   res = mongoc_collection_command_simple (collection, command,
                                           NULL, &amp;reply, &amp;error);
   if (!res) {
      fprintf (stderr, "Error with explain: %s\n", error.message);
      goto cleanup;
   }

   /* Do something with the reply */
   print_res (&amp;reply);

cleanup:
   bson_destroy(&amp;reply);
   bson_destroy (command);
   return res;
}</pre></div>
</div></div>
</div></div>
<div id="copydb" class="sect"><div class="inner">
<div class="hgroup"><h3 class="title"><span class="title">"copydb" Command</span></h3></div>
<div class="region"><div class="contents">
<p class="p">This example requires two instances of mongo to be running.</p>
<p class="p">Here's how to use the <span class="code">copydb</span> command to copy a database from another instance of MongoDB:</p>
<div class="code"><pre class="contents syntax brush-clang">bool copydb (mongoc_client_t* client, const char* other_host_and_port)
{
   mongoc_database_t* admindb;
   bson_t* command;
   bson_t reply;
   bson_error_t error;
   bool res;

   BSON_ASSERT (other_host_and_port);
   /* Must do this from the admin db */
   admindb = mongoc_client_get_database (client, "admin");

   command = BCON_NEW ("copydb", BCON_INT32 (1),
                       "fromdb", BCON_UTF8 ("test"),
                       "todb", BCON_UTF8 ("test2"),

                       /* If you want from a different host */
                       "fromhost", BCON_UTF8 (other_host_and_port));
   res = mongoc_database_command_simple (admindb, command, NULL,
                                         &amp;reply, &amp;error);
   if (!res) {
      fprintf (stderr, "Error with copydb: %s\n", error.message);
      goto cleanup;
   }

   /* Do something with the reply */
   print_res (&amp;reply);

cleanup:
   bson_destroy(&amp;reply);
   bson_destroy (command);
   mongoc_database_destroy (admindb);

   return res;
}</pre></div>
</div></div>
</div></div>
<div id="clone-collection" class="sect"><div class="inner">
<div class="hgroup"><h3 class="title"><span class="title">"cloneCollection" Command</span></h3></div>
<div class="region"><div class="contents">
<p class="p">This example requires two instances of mongo to be running.</p>
<p class="p">Here's an example of the <span class="code">cloneCollection</span> command to clone a collection from another instance of MongoDB:</p>
<div class="code"><pre class="contents syntax brush-clang">bool clone_collection (mongoc_database_t* database,
                       const char* other_host_and_port)
{
   bson_t* command;
   bson_t reply;
   bson_error_t error;
   bool res;

   BSON_ASSERT (other_host_and_port);
   command = BCON_NEW ("cloneCollection", BCON_UTF8 ("test.remoteThings"),
                       "from", BCON_UTF8 (other_host_and_port),
                       "query", "{", "x", BCON_INT32 (1), "}");
   res = mongoc_database_command_simple (database, command, NULL,
                                         &amp;reply, &amp;error);
   if (!res) {
      fprintf (stderr, "Error with clone: %s\n", error.message);
      goto cleanup;
   }

   /* Do something with the reply */
   print_res (&amp;reply);

cleanup:
   bson_destroy (&amp;reply);
   bson_destroy (command);

   return res;
}</pre></div>
</div></div>
</div></div>
<div id="main" class="sect"><div class="inner">
<div class="hgroup"><h3 class="title"><span class="title">Running</span></h3></div>
<div class="region"><div class="contents">
<div class="listing"><div class="inner">
<div class="title title-listing"><h4><span class="title">examples/common-operations.c</span></h4></div>
<div class="region"><div class="contents"><div class="code"><pre class="contents syntax brush-clang">/*
 * Copyright 2016 MongoDB, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


#include &lt;mongoc.h&gt;
#include &lt;stdio.h&gt;


const char* COLLECTION_NAME = "things";

#include "../doc-common-insert.c"
#include "explain.c"
#include "copydb.c"
#include "clone-collection.c"


int
main (int   argc,
      char *argv[])
{
   mongoc_database_t *database = NULL;
   mongoc_client_t *client = NULL;
   mongoc_collection_t *collection = NULL;
   char *host_and_port;
   int res = 0;
   char* other_host_and_port = NULL;

   if (argc &lt; 2 || argc &gt; 3) {
      fprintf (stderr, "usage: %s MONGOD-1-CONNECTION-STRING "
               "[MONGOD-2-HOST-NAME:MONGOD-2-PORT]\n",
               argv[0]);
      fprintf (stderr,
               "MONGOD-1-CONNECTION-STRING can be "
               "of the following forms:\n");
      fprintf (stderr, "localhost\t\t\t\tlocal machine\n");
      fprintf (stderr, "localhost:27018\t\t\t\tlocal machine on port 27018\n");
      fprintf (stderr,
               "mongodb://user:pass@localhost:27017\t"
               "local machine on port 27017, and authenticate with username "
               "user and password pass\n");
      return 1;
   }

   mongoc_init ();

   if (strncmp (argv[1], "mongodb://", 10) == 0) {
      host_and_port = bson_strdup (argv [1]);
   } else {
      host_and_port = bson_strdup_printf ("mongodb://%s", argv[1]);
   }
   other_host_and_port = argc &gt; 2 ? argv[2] : NULL;

   client = mongoc_client_new (host_and_port);

   if (!client) {
      fprintf(stderr, "Invalid hostname or port: %s\n", host_and_port);
      res = 2;
      goto cleanup;
   }

   mongoc_client_set_error_api (client, 2);
   database = mongoc_client_get_database (client, "test");
   collection = mongoc_database_get_collection (database, COLLECTION_NAME);

   printf ("Inserting data\n");
   if (!insert_data (collection)) {
      res = 3;
      goto cleanup;
   }

   printf ("explain\n");
   if (!explain (collection)) {
      res = 4;
      goto cleanup;
   }

   if (other_host_and_port) {
      printf ("copydb\n");
      if (!copydb (client, other_host_and_port)) {
         res = 5;
         goto cleanup;
      }

      printf ("clone collection\n");
      if (!clone_collection (database, other_host_and_port)) {
         res = 6;
         goto cleanup;
      }
   }

cleanup:
   if (collection) {
      mongoc_collection_destroy (collection);
   }

   if (database) {
      mongoc_database_destroy (database);
   }

   if (client) {
      mongoc_client_destroy (client);
   }

   bson_free (host_and_port);
   mongoc_cleanup ();
   return res;
}</pre></div></div></div>
</div></div>
<p class="p">First launch two separate instances of mongod (must be done from separate shells):</p>
<div class="screen"><pre class="contents "><span class="prompt output">$ </span><span class="input">mongod</span></pre></div>
<div class="screen"><pre class="contents "><span class="prompt output">$ </span><span class="input">mkdir /tmp/db2</span>
<span class="prompt output">$ </span><span class="input">mongod --dbpath /tmp/db2 --port 27018 # second instance</span></pre></div>
<p class="p">Now compile and run the example program:</p>
<div class="screen"><pre class="contents "><span class="prompt output">$ </span><span class="input">cd examples/common_operations/</span>
<span class="prompt output">$ </span><span class="input">gcc -Wall -o example common-operations.c $(pkg-config --cflags --libs libmongoc-1.0)</span>
<span class="prompt output">$ </span><span class="input">./example localhost:27017 localhost:27018</span>
<span class="output">
Inserting data
explain
{
   "executionStats" : {
      "allPlansExecution" : [],
      "executionStages" : {
         "advanced" : 19,
         "direction" : "forward" ,
         "docsExamined" : 76,
         "executionTimeMillisEstimate" : 0,
         "filter" : {
            "x" : {
               "$eq" : 1
            }
         },
         "invalidates" : 0,
         "isEOF" : 1,
         "nReturned" : 19,
         "needTime" : 58,
         "needYield" : 0,
         "restoreState" : 0,
         "saveState" : 0,
         "stage" : "COLLSCAN" ,
         "works" : 78
      },
      "executionSuccess" : true,
      "executionTimeMillis" : 0,
      "nReturned" : 19,
      "totalDocsExamined" : 76,
      "totalKeysExamined" : 0
   },
   "ok" : 1,
   "queryPlanner" : {
      "indexFilterSet" : false,
      "namespace" : "test.things",
      "parsedQuery" : {
         "x" : {
            "$eq" : 1
         }
      },
      "plannerVersion" : 1,
      "rejectedPlans" : [],
      "winningPlan" : {
         "direction" : "forward" ,
         "filter" : {
            "x" : {
               "$eq" : 1
            }
         },
         "stage" : "COLLSCAN"
      }
   },
   "serverInfo" : {
      "gitVersion" : "05552b562c7a0b3143a729aaa0838e558dc49b25" ,
      "host" : "MacBook-Pro-57.local",
      "port" : 27017,
      "version" : "3.2.6"
   }
}
copydb
{ "ok" : 1 }
clone collection
{ "ok" : 1 }
</span>

  </pre></div>
</div></div>
</div></div>
</div>
</div></div>
<div class="sect sect-links" role="navigation">
<div class="hgroup"></div>
<div class="contents"><div class="links guidelinks"><div class="inner">
<div class="title"><h2><span class="title">More Information</span></h2></div>
<div class="region"><ul><li class="links "><a href="index.html#basic-operations" title="Basic Operations">Basic Operations</a></li></ul></div>
</div></div></div>
</div>
</div>
<div class="clear"></div>
</div>
<div class="footer"></div>
</div></body>
</html>
