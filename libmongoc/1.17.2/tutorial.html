
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7301842-14"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-7301842-14');
</script>
<link rel="canonical" href="http://mongoc.org/libbson/current/tutorial.html"/>
    <title>Tutorial &#8212; libmongoc 1.17.2</title>
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Authentication" href="authentication.html" />
    <link rel="prev" title="Installing the MongoDB C Driver (libmongoc) and BSON library (libbson)" href="installing.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
<div style="text-align: center; border: 1px solid gray; padding: 10px; background: #d4f1ff">
  This is an outdated version of the documentation.
  <a href="http://mongoc.org/libmongoc/current/tutorial.html" 
     style="color: black; font-weight: bold; text-decoration: underline;">
    See the current version of this page</a>.
</div>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="authentication.html" title="Authentication"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="installing.html" title="Installing the MongoDB C Driver (libmongoc) and BSON library (libbson)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">libmongoc 1.17.2</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial">
<h1><a class="toc-backref" href="#id6">Tutorial</a><a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>This guide offers a brief introduction to the MongoDB C Driver.</p>
<p>For more information on the C API, please refer to the <a class="reference internal" href="api.html"><span class="doc">API Reference</span></a>.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#tutorial" id="id6">Tutorial</a></p>
<ul>
<li><p><a class="reference internal" href="#installing" id="id7">Installing</a></p></li>
<li><p><a class="reference internal" href="#starting-mongodb" id="id8">Starting MongoDB</a></p></li>
<li><p><a class="reference internal" href="#include-and-link-libmongoc-in-your-c-program" id="id9">Include and link libmongoc in your C program</a></p></li>
<li><p><a class="reference internal" href="#use-libmongoc-in-a-microsoft-visual-studio-project" id="id10">Use libmongoc in a Microsoft Visual Studio Project</a></p></li>
<li><p><a class="reference internal" href="#making-a-connection" id="id11">Making a Connection</a></p></li>
<li><p><a class="reference internal" href="#creating-bson-documents" id="id12">Creating BSON Documents</a></p></li>
<li><p><a class="reference internal" href="#basic-crud-operations" id="id13">Basic CRUD Operations</a></p></li>
<li><p><a class="reference internal" href="#executing-commands" id="id14">Executing Commands</a></p></li>
<li><p><a class="reference internal" href="#threading" id="id15">Threading</a></p></li>
<li><p><a class="reference internal" href="#next-steps" id="id16">Next Steps</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="installing">
<h2><a class="toc-backref" href="#id7">Installing</a><a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h2>
<p>For detailed instructions on installing the MongoDB C Driver on a particular platform, please see the <a class="reference internal" href="installing.html"><span class="doc">installation guide</span></a>.</p>
</div>
<div class="section" id="starting-mongodb">
<h2><a class="toc-backref" href="#id8">Starting MongoDB</a><a class="headerlink" href="#starting-mongodb" title="Permalink to this headline">¶</a></h2>
<p>To run the examples in this tutorial, MongoDB must be installed and running on <code class="docutils literal notranslate"><span class="pre">localhost</span></code> on the default port, 27017. To check if it is up and running, connect to it with the MongoDB shell.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mongo --host localhost --port 27017
MongoDB shell version: 3.0.6
connecting to: localhost:27017/test
&gt;
</pre></div>
</div>
</div>
<div class="section" id="include-and-link-libmongoc-in-your-c-program">
<h2><a class="toc-backref" href="#id9">Include and link libmongoc in your C program</a><a class="headerlink" href="#include-and-link-libmongoc-in-your-c-program" title="Permalink to this headline">¶</a></h2>
<div class="section" id="include-mongoc-h">
<h3>Include mongoc.h<a class="headerlink" href="#include-mongoc-h" title="Permalink to this headline">¶</a></h3>
<p>All libmongoc’s functions and types are available in one header file. Simply include <code class="docutils literal notranslate"><span class="pre">mongoc/mongoc.h</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<div class="section" id="cmake">
<h4>CMake<a class="headerlink" href="#cmake" title="Permalink to this headline">¶</a></h4>
<p>The libmongoc installation includes a <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#config-file-packages">CMake config-file package</a>, so you can use CMake’s <a class="reference external" href="https://cmake.org/cmake/help/latest/command/find_package.html">find_package</a> command to import libmongoc’s CMake target and link to libmongoc (as a shared library):</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">CMakeLists.txt</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the minimum version you require.</span>
<span class="n">find_package</span> <span class="p">(</span><span class="n">mongoc</span><span class="o">-</span><span class="mf">1.0</span> <span class="mf">1.7</span> <span class="n">REQUIRED</span><span class="p">)</span>

<span class="c1"># The &quot;hello_mongoc.c&quot; sample program is shared among four tests.</span>
<span class="n">add_executable</span> <span class="p">(</span><span class="n">hello_mongoc</span> <span class="o">../../</span><span class="n">hello_mongoc</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
<span class="n">target_link_libraries</span> <span class="p">(</span><span class="n">hello_mongoc</span> <span class="n">PRIVATE</span> <span class="n">mongo</span><span class="p">::</span><span class="n">mongoc_shared</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can also use libmongoc as a static library instead: Use the <code class="docutils literal notranslate"><span class="pre">mongo::mongoc_static</span></code> CMake target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the minimum version you require.</span>
<span class="hll"><span class="n">find_package</span> <span class="p">(</span><span class="n">mongoc</span><span class="o">-</span><span class="mf">1.0</span> <span class="mf">1.7</span> <span class="n">REQUIRED</span><span class="p">)</span>
</span>
<span class="c1"># The &quot;hello_mongoc.c&quot; sample program is shared among four tests.</span>
<span class="n">add_executable</span> <span class="p">(</span><span class="n">hello_mongoc</span> <span class="o">../../</span><span class="n">hello_mongoc</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
<span class="n">target_link_libraries</span> <span class="p">(</span><span class="n">hello_mongoc</span> <span class="n">PRIVATE</span> <span class="n">mongo</span><span class="p">::</span><span class="n">mongoc_static</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pkg-config">
<h4>pkg-config<a class="headerlink" href="#pkg-config" title="Permalink to this headline">¶</a></h4>
<p>If you’re not using CMake, use <a class="reference external" href="https://www.freedesktop.org/wiki/Software/pkg-config/">pkg-config</a> on the command line to set header and library paths:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gcc -o hello_mongoc hello_mongoc.c $(pkg-config --libs --cflags libmongoc-1.0)
</pre></div>
</div>
<p>Or to statically link to libmongoc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gcc -o hello_mongoc hello_mongoc.c $(pkg-config --libs --cflags libmongoc-static-1.0)
</pre></div>
</div>
</div>
<div class="section" id="specifying-header-and-include-paths-manually">
<h4>Specifying header and include paths manually<a class="headerlink" href="#specifying-header-and-include-paths-manually" title="Permalink to this headline">¶</a></h4>
<p>If you aren’t using CMake or pkg-config, paths and libraries can be managed manually.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o hello_mongoc hello_mongoc.c \
    -I/usr/local/include/libbson-1.0 -I/usr/local/include/libmongoc-1.0 \
    -lmongoc-1.0 -lbson-1.0
$ ./hello_mongoc
{ &quot;ok&quot; : 1.000000 }
</pre></div>
</div>
<p>For Windows users, the code can be compiled and run with the following commands. (This assumes that the MongoDB C Driver has been installed to <code class="docutils literal notranslate"><span class="pre">C:\mongo-c-driver</span></code>; change the include directory as needed.)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 hello_mongoc.c
C:\&gt; hello_mongoc
{ &quot;ok&quot; : 1.000000 }
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="use-libmongoc-in-a-microsoft-visual-studio-project">
<span id="tutorial-connecting"></span><h2><a class="toc-backref" href="#id10">Use libmongoc in a Microsoft Visual Studio Project</a><a class="headerlink" href="#use-libmongoc-in-a-microsoft-visual-studio-project" title="Permalink to this headline">¶</a></h2>
<p>See the <a class="reference internal" href="visual-studio-guide.html"><span class="doc">libmongoc and Visual Studio guide</span></a>.</p>
</div>
<div class="section" id="making-a-connection">
<span id="id2"></span><h2><a class="toc-backref" href="#id11">Making a Connection</a><a class="headerlink" href="#making-a-connection" title="Permalink to this headline">¶</a></h2>
<p>Access MongoDB with a <a class="symbol reference internal" href="mongoc_client_t.html"><span class="doc">mongoc_client_t</span></a>. It transparently connects to standalone servers, replica sets and sharded clusters on demand. To perform operations on a database or collection, create a <a class="symbol reference internal" href="mongoc_database_t.html"><span class="doc">mongoc_database_t</span></a> or <a class="symbol reference internal" href="mongoc_collection_t.html"><span class="doc">mongoc_collection_t</span></a> struct from the <a class="symbol reference internal" href="mongoc_client_t.html"><span class="doc">mongoc_client_t</span></a>.</p>
<p>At the start of an application, call <a class="symbol reference internal" href="mongoc_init.html"><span class="doc">mongoc_init()</span></a> before any other libmongoc functions. At the end, call the appropriate destroy function for each collection, database, or client handle, in reverse order from how they were constructed. Call <a class="symbol reference internal" href="mongoc_cleanup.html"><span class="doc">mongoc_cleanup()</span></a> before exiting.</p>
<p>The example below establishes a connection to a standalone server on <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, registers the client application as “connect-example,” and performs a simple command.</p>
<p>More information about database operations can be found in the <a class="reference internal" href="#tutorial-crud-operations"><span class="std std-ref">CRUD Operations</span></a> and <a class="reference internal" href="#tutorial-executing-commands"><span class="std std-ref">Executing Commands</span></a> sections. Examples of connecting to replica sets and sharded clusters can be found on the <a class="reference internal" href="advanced-connections.html"><span class="doc">Advanced Connections</span></a> page.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">hello_mongoc.c</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://localhost:27017&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_database_t</span> <span class="o">*</span><span class="n">database</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="o">*</span><span class="n">insert</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">retval</span><span class="p">;</span>

   <span class="cm">/*</span>
<span class="cm">    * Required to initialize libmongoc&#39;s internals</span>
<span class="cm">    */</span>
   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="cm">/*</span>
<span class="cm">    * Optionally get MongoDB URI from command line</span>
<span class="cm">    */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">uri_string</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
   <span class="p">}</span>

   <span class="cm">/*</span>
<span class="cm">    * Safely create a MongoDB URI object from the given string</span>
<span class="cm">    */</span>
   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/*</span>
<span class="cm">    * Create a new client instance</span>
<span class="cm">    */</span>
   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new_from_uri</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/*</span>
<span class="cm">    * Register the application name so we can track it in the profile logs</span>
<span class="cm">    * on the server. This can also be done from the URI (see other examples).</span>
<span class="cm">    */</span>
   <span class="n">mongoc_client_set_appname</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;connect-example&quot;</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Get a handle on the database &quot;db_name&quot; and collection &quot;coll_name&quot;</span>
<span class="cm">    */</span>
   <span class="n">database</span> <span class="o">=</span> <span class="n">mongoc_client_get_database</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;db_name&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;db_name&quot;</span><span class="p">,</span> <span class="s">&quot;coll_name&quot;</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Do work. This example pings the database, prints the result as JSON and</span>
<span class="cm">    * performs an insert</span>
<span class="cm">    */</span>
   <span class="n">command</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;ping&quot;</span><span class="p">,</span> <span class="n">BCON_INT32</span> <span class="p">(</span><span class="mi">1</span><span class="p">));</span>

   <span class="n">retval</span> <span class="o">=</span> <span class="n">mongoc_client_command_simple</span> <span class="p">(</span>
      <span class="n">client</span><span class="p">,</span> <span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

   <span class="n">insert</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">));</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_collection_insert_one</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">insert</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">insert</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Release our handles and clean up libmongoc</span>
<span class="cm">    */</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_database_destroy</span> <span class="p">(</span><span class="n">database</span><span class="p">);</span>
   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-bson-documents">
<h2><a class="toc-backref" href="#id12">Creating BSON Documents</a><a class="headerlink" href="#creating-bson-documents" title="Permalink to this headline">¶</a></h2>
<p>Documents are stored in MongoDB’s data format, BSON. The C driver uses <a class="reference external" href="http://mongoc.org/libbson/current/index.html" title="(in libbson v1.17.2)"><span class="xref std std-doc">libbson</span></a> to create BSON documents. There are several ways to construct them: appending key-value pairs, using BCON, or parsing JSON.</p>
<div class="section" id="appending-bson">
<h3>Appending BSON<a class="headerlink" href="#appending-bson" title="Permalink to this headline">¶</a></h3>
<p>A BSON document, represented as a <a class="reference external" href="http://mongoc.org/libbson/current/bson_t.html" title="(in libbson v1.17.2)"><span class="xref std std-doc">bson_t</span></a> in code, can be constructed one field at a time using libbson’s append functions.</p>
<p>For example, to create a document like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{
   born : ISODate(&quot;1906-12-09&quot;),
   died : ISODate(&quot;1992-01-01&quot;),
   name : {
      first : &quot;Grace&quot;,
      last : &quot;Hopper&quot;
   },
   languages : [ &quot;MATH-MATIC&quot;, &quot;FLOW-MATIC&quot;, &quot;COBOL&quot; ],
   degrees: [ { degree: &quot;BA&quot;, school: &quot;Vassar&quot; }, { degree: &quot;PhD&quot;, school: &quot;Yale&quot; } ]
}
</pre></div>
</div>
<p>Use the following code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span>   <span class="n">argc</span><span class="p">,</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="nc">tm</span>   <span class="n">born</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
   <span class="k">struct</span> <span class="nc">tm</span>   <span class="n">died</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lang_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;MATH-MATIC&quot;</span><span class="p">,</span> <span class="s">&quot;FLOW-MATIC&quot;</span><span class="p">,</span> <span class="s">&quot;COBOL&quot;</span><span class="p">};</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">schools</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Vassar&quot;</span><span class="p">,</span> <span class="s">&quot;Yale&quot;</span><span class="p">};</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">degrees</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;BA&quot;</span><span class="p">,</span> <span class="s">&quot;PhD&quot;</span><span class="p">};</span>
   <span class="kt">uint32_t</span>    <span class="n">i</span><span class="p">;</span>
   <span class="kt">char</span>        <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
   <span class="k">const</span>       <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
   <span class="kt">size_t</span>      <span class="n">keylen</span><span class="p">;</span>
   <span class="n">bson_t</span>     <span class="o">*</span><span class="n">document</span><span class="p">;</span>
   <span class="n">bson_t</span>      <span class="n">child</span><span class="p">;</span>
   <span class="n">bson_t</span>      <span class="n">child2</span><span class="p">;</span>
   <span class="kt">char</span>       <span class="o">*</span><span class="n">str</span><span class="p">;</span>

   <span class="n">document</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>

   <span class="cm">/*</span>
<span class="cm">    * Append { &quot;born&quot; : ISODate(&quot;1906-12-09&quot;) } to the document.</span>
<span class="cm">    * Passing -1 for the length argument tells libbson to calculate the string length.</span>
<span class="cm">    */</span>
   <span class="n">born</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>  <span class="cm">/* years are 1900-based */</span>
   <span class="n">born</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>  <span class="cm">/* months are 0-based */</span>
   <span class="n">born</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
   <span class="n">bson_append_date_time</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s">&quot;born&quot;</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="n">mktime</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">born</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Append { &quot;died&quot; : ISODate(&quot;1992-01-01&quot;) } to the document.</span>
<span class="cm">    */</span>
   <span class="n">died</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span>
   <span class="n">died</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">died</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="cm">/*</span>
<span class="cm">    * For convenience, this macro passes length -1 by default.</span>
<span class="cm">    */</span>
   <span class="n">BSON_APPEND_DATE_TIME</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s">&quot;died&quot;</span><span class="p">,</span> <span class="n">mktime</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">died</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Append a subdocument.</span>
<span class="cm">    */</span>
   <span class="n">BSON_APPEND_DOCUMENT_BEGIN</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>
   <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="s">&quot;Grace&quot;</span><span class="p">);</span>
   <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="s">&quot;last&quot;</span><span class="p">,</span> <span class="s">&quot;Hopper&quot;</span><span class="p">);</span>
   <span class="n">bson_append_document_end</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Append array of strings. Generate keys &quot;0&quot;, &quot;1&quot;, &quot;2&quot;.</span>
<span class="cm">    */</span>
   <span class="n">BSON_APPEND_ARRAY_BEGIN</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s">&quot;languages&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="n">lang_names</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">keylen</span> <span class="o">=</span> <span class="n">bson_uint32_to_string</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
      <span class="n">bson_append_utf8</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">lang_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">-1</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">bson_append_array_end</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Array of subdocuments:</span>
<span class="cm">    *    degrees: [ { degree: &quot;BA&quot;, school: &quot;Vassar&quot; }, ... ]</span>
<span class="cm">    */</span>
   <span class="n">BSON_APPEND_ARRAY_BEGIN</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="s">&quot;degrees&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="n">degrees</span> <span class="o">/</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">keylen</span> <span class="o">=</span> <span class="n">bson_uint32_to_string</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
      <span class="n">bson_append_document_begin</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">keylen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child2</span><span class="p">);</span>
      <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child2</span><span class="p">,</span> <span class="s">&quot;degree&quot;</span><span class="p">,</span> <span class="n">degrees</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child2</span><span class="p">,</span> <span class="s">&quot;school&quot;</span><span class="p">,</span> <span class="n">schools</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">bson_append_document_end</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child2</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">bson_append_array_end</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Print the document as a JSON string.</span>
<span class="cm">    */</span>
   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Clean up allocated bson documents.</span>
<span class="cm">    */</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">document</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See the <a class="reference external" href="http://mongoc.org/libbson/current/bson_t.html" title="(in libbson v1.17.2)"><span class="xref std std-doc">libbson documentation</span></a> for all of the types that can be appended to a <a class="symbol reference external" href="http://mongoc.org/libbson/current/bson_t.html" title="(in libbson v1.17.2)"><code class="xref symbol docutils literal notranslate"><span class="pre">bson_t</span></code></a>.</p>
</div>
<div class="section" id="using-bcon">
<h3>Using BCON<a class="headerlink" href="#using-bcon" title="Permalink to this headline">¶</a></h3>
<p><em>BSON C Object Notation</em>, BCON for short, is an alternative way of constructing BSON documents in a manner closer to the intended format. It has less type-safety than BSON’s append functions but results in less code.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span>   <span class="n">argc</span><span class="p">,</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="k">struct</span> <span class="nc">tm</span> <span class="n">born</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
   <span class="k">struct</span> <span class="nc">tm</span> <span class="n">died</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
   <span class="n">bson_t</span>   <span class="o">*</span><span class="n">document</span><span class="p">;</span>
   <span class="kt">char</span>     <span class="o">*</span><span class="n">str</span><span class="p">;</span>

   <span class="n">born</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
   <span class="n">born</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
   <span class="n">born</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

   <span class="n">died</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span>
   <span class="n">died</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">died</span><span class="p">.</span><span class="n">tm_mday</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="n">document</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span>
      <span class="s">&quot;born&quot;</span><span class="p">,</span> <span class="n">BCON_DATE_TIME</span> <span class="p">(</span><span class="n">mktime</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">born</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
      <span class="s">&quot;died&quot;</span><span class="p">,</span> <span class="n">BCON_DATE_TIME</span> <span class="p">(</span><span class="n">mktime</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">died</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>
      <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;{&quot;</span><span class="p">,</span>
      <span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;Grace&quot;</span><span class="p">),</span>
      <span class="s">&quot;last&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;Hopper&quot;</span><span class="p">),</span>
      <span class="s">&quot;}&quot;</span><span class="p">,</span>
      <span class="s">&quot;languages&quot;</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">,</span>
      <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;MATH-MATIC&quot;</span><span class="p">),</span>
      <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;FLOW-MATIC&quot;</span><span class="p">),</span>
      <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;COBOL&quot;</span><span class="p">),</span>
      <span class="s">&quot;]&quot;</span><span class="p">,</span>
      <span class="s">&quot;degrees&quot;</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">,</span>
      <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;degree&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;BA&quot;</span><span class="p">),</span> <span class="s">&quot;school&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;Vassar&quot;</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">,</span>
      <span class="s">&quot;{&quot;</span><span class="p">,</span> <span class="s">&quot;degree&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;PhD&quot;</span><span class="p">),</span> <span class="s">&quot;school&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;Yale&quot;</span><span class="p">),</span> <span class="s">&quot;}&quot;</span><span class="p">,</span>
      <span class="s">&quot;]&quot;</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Print the document as a JSON string.</span>
<span class="cm">    */</span>
   <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>

   <span class="cm">/*</span>
<span class="cm">    * Clean up allocated bson documents.</span>
<span class="cm">    */</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">document</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that BCON can create arrays, subdocuments and arbitrary fields.</p>
</div>
<div class="section" id="creating-bson-from-json">
<h3>Creating BSON from JSON<a class="headerlink" href="#creating-bson-from-json" title="Permalink to this headline">¶</a></h3>
<p>For <em>single</em> documents, BSON can be created from JSON strings via <a class="reference external" href="http://mongoc.org/libbson/current/bson_new_from_json.html" title="(in libbson v1.17.2)"><span class="xref std std-doc">bson_new_from_json</span></a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span>   <span class="n">argc</span><span class="p">,</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span>      <span class="o">*</span><span class="n">bson</span><span class="p">;</span>
   <span class="kt">char</span>        <span class="o">*</span><span class="n">string</span><span class="p">;</span>

   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">json</span> <span class="o">=</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">name</span><span class="se">\&quot;</span><span class="s">: {</span><span class="se">\&quot;</span><span class="s">first</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">Grace</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">last</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">Hopper</span><span class="se">\&quot;</span><span class="s">}}&quot;</span><span class="p">;</span>
   <span class="n">bson</span> <span class="o">=</span> <span class="n">bson_new_from_json</span> <span class="p">((</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">json</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bson</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">string</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="n">bson</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
   <span class="n">bson_free</span> <span class="p">(</span><span class="n">string</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To initialize BSON from a sequence of JSON documents, use <a class="reference external" href="http://mongoc.org/libbson/current/bson_json_reader_t.html" title="(in libbson v1.17.2)"><span class="xref std std-doc">bson_json_reader_t</span></a>.</p>
</div>
</div>
<div class="section" id="basic-crud-operations">
<span id="tutorial-crud-operations"></span><h2><a class="toc-backref" href="#id13">Basic CRUD Operations</a><a class="headerlink" href="#basic-crud-operations" title="Permalink to this headline">¶</a></h2>
<p>This section demonstrates the basics of using the C Driver to interact with MongoDB.</p>
<div class="section" id="inserting-a-document">
<h3>Inserting a Document<a class="headerlink" href="#inserting-a-document" title="Permalink to this headline">¶</a></h3>
<p>To insert documents into a collection, first obtain a handle to a <code class="docutils literal notranslate"><span class="pre">mongoc_collection_t</span></code> via a <code class="docutils literal notranslate"><span class="pre">mongoc_client_t</span></code>. Then, use <a class="symbol reference internal" href="mongoc_collection_insert_one.html"><span class="doc">mongoc_collection_insert_one()</span></a> to add BSON documents to the collection. This example inserts into the database “mydb” and collection “mycoll”.</p>
<p>When finished, ensure that allocated structures are freed by using their respective destroy functions.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span>   <span class="n">argc</span><span class="p">,</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
    <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
    <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
    <span class="n">bson_oid_t</span> <span class="n">oid</span><span class="p">;</span>
    <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>

    <span class="n">mongoc_init</span> <span class="p">();</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost:27017/?appname=insert-example&quot;</span><span class="p">);</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;mydb&quot;</span><span class="p">,</span> <span class="s">&quot;mycoll&quot;</span><span class="p">);</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
    <span class="n">bson_oid_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">BSON_APPEND_OID</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">);</span>
    <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_collection_insert_one</span> <span class="p">(</span>
           <span class="n">collection</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
    <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
    <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
    <span class="n">mongoc_cleanup</span> <span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile the code and run it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o insert insert.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./insert
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 insert.c
C:\&gt; insert
</pre></div>
</div>
<p>To verify that the insert succeeded, connect with the MongoDB shell.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mongo
MongoDB shell version: 3.0.6
connecting to: test
&gt; use mydb
switched to db mydb
&gt; db.mycoll.find()
{ &quot;_id&quot; : ObjectId(&quot;55ef43766cb5f36a3bae6ee4&quot;), &quot;hello&quot; : &quot;world&quot; }
&gt;
</pre></div>
</div>
</div>
<div class="section" id="finding-a-document">
<span id="tutorial-find"></span><h3>Finding a Document<a class="headerlink" href="#finding-a-document" title="Permalink to this headline">¶</a></h3>
<p>To query a MongoDB collection with the C driver, use the function <a class="reference internal" href="mongoc_collection_find_with_opts.html"><span class="doc">mongoc_collection_find_with_opts()</span></a>. This returns a <a class="reference internal" href="mongoc_cursor_t.html"><span class="doc">cursor</span></a> to the matching documents. The following examples iterate through the result cursors and print the matches to <code class="docutils literal notranslate"><span class="pre">stdout</span></code> as JSON strings.</p>
<p>Use a document as a query specifier; for example,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>{ &quot;color&quot; : &quot;red&quot; }
</pre></div>
</div>
<p>will match any document with a field named “color” with value “red”. An empty document <code class="docutils literal notranslate"><span class="pre">{}</span></code> can be used to match all documents.</p>
<p>This first example uses an empty query specifier to find all documents in the database “mydb” and collection “mycoll”.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">mongoc_cursor_t</span> <span class="o">*</span><span class="n">cursor</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost:27017/?appname=find-example&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;mydb&quot;</span><span class="p">,</span> <span class="s">&quot;mycoll&quot;</span><span class="p">);</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">cursor</span> <span class="o">=</span> <span class="n">mongoc_collection_find_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="k">while</span> <span class="p">(</span><span class="n">mongoc_cursor_next</span> <span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">doc</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
      <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="n">mongoc_cursor_destroy</span> <span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile the code and run it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o find find.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./find
{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;55ef43766cb5f36a3bae6ee4&quot; }, &quot;hello&quot; : &quot;world&quot; }
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 find.c
C:\&gt; find
{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;55ef43766cb5f36a3bae6ee4&quot; }, &quot;hello&quot; : &quot;world&quot; }
</pre></div>
</div>
<p>To look for a specific document, add a specifier to <code class="docutils literal notranslate"><span class="pre">query</span></code>. This example adds a call to <code class="docutils literal notranslate"><span class="pre">BSON_APPEND_UTF8()</span></code> to look for all documents matching <code class="docutils literal notranslate"><span class="pre">{&quot;hello&quot;</span> <span class="pre">:</span> <span class="pre">&quot;world&quot;}</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">mongoc_cursor_t</span> <span class="o">*</span><span class="n">cursor</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span>
      <span class="s">&quot;mongodb://localhost:27017/?appname=find-specific-example&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;mydb&quot;</span><span class="p">,</span> <span class="s">&quot;mycoll&quot;</span><span class="p">);</span>
   <span class="n">query</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">);</span>

   <span class="n">cursor</span> <span class="o">=</span> <span class="n">mongoc_collection_find_with_opts</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="k">while</span> <span class="p">(</span><span class="n">mongoc_cursor_next</span> <span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">doc</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
      <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="n">mongoc_cursor_destroy</span> <span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o find-specific find-specific.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./find-specific
{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;55ef43766cb5f36a3bae6ee4&quot; }, &quot;hello&quot; : &quot;world&quot; }
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 find-specific.c
C:\&gt; find-specific
{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;55ef43766cb5f36a3bae6ee4&quot; }, &quot;hello&quot; : &quot;world&quot; }
</pre></div>
</div>
</div>
<div class="section" id="updating-a-document">
<h3>Updating a Document<a class="headerlink" href="#updating-a-document" title="Permalink to this headline">¶</a></h3>
<p>This code snippet gives an example of using <a class="reference internal" href="mongoc_collection_update_one.html"><span class="doc">mongoc_collection_update_one()</span></a> to update the fields of a document.</p>
<p>Using the “mydb” database, the following example inserts an example document into the “mycoll” collection. Then, using its <code class="docutils literal notranslate"><span class="pre">_id</span></code> field, the document is updated with different values and a new field.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_oid_t</span> <span class="n">oid</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">update</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost:27017/?appname=update-example&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;mydb&quot;</span><span class="p">,</span> <span class="s">&quot;mycoll&quot;</span><span class="p">);</span>

   <span class="n">bson_oid_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_OID</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">),</span> <span class="s">&quot;key&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;old_value&quot;</span><span class="p">));</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_collection_insert_one</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">query</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="n">BCON_OID</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">));</span>
   <span class="n">update</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;$set&quot;</span><span class="p">,</span>
                      <span class="s">&quot;{&quot;</span><span class="p">,</span>
                      <span class="s">&quot;key&quot;</span><span class="p">,</span>
                      <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;new_value&quot;</span><span class="p">),</span>
                      <span class="s">&quot;updated&quot;</span><span class="p">,</span>
                      <span class="n">BCON_BOOL</span> <span class="p">(</span><span class="nb">true</span><span class="p">),</span>
                      <span class="s">&quot;}&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_collection_update_one</span> <span class="p">(</span>
          <span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
   <span class="p">}</span>

<span class="nl">fail</span><span class="p">:</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
      <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span>
      <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">query</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>
      <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">update</span><span class="p">);</span>

   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile the code and run it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o update update.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./update
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 update.c
C:\&gt; update
{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;55ef43766cb5f36a3bae6ee4&quot; }, &quot;hello&quot; : &quot;world&quot; }
</pre></div>
</div>
<p>To verify that the update succeeded, connect with the MongoDB shell.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mongo
MongoDB shell version: 3.0.6
connecting to: test
&gt; use mydb
switched to db mydb
&gt; db.mycoll.find({&quot;updated&quot; : true})
{ &quot;_id&quot; : ObjectId(&quot;55ef549236fe322f9490e17b&quot;), &quot;updated&quot; : true, &quot;key&quot; : &quot;new_value&quot; }
&gt;
</pre></div>
</div>
</div>
<div class="section" id="deleting-a-document">
<h3>Deleting a Document<a class="headerlink" href="#deleting-a-document" title="Permalink to this headline">¶</a></h3>
<p>This example illustrates the use of <a class="symbol reference internal" href="mongoc_collection_delete_one.html"><span class="doc">mongoc_collection_delete_one()</span></a> to delete a document.</p>
<p>The following code inserts a sample document into the database “mydb” and collection “mycoll”. Then, it deletes all documents matching <code class="docutils literal notranslate"><span class="pre">{&quot;hello&quot;</span> <span class="pre">:</span> <span class="pre">&quot;world&quot;}</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_oid_t</span> <span class="n">oid</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost:27017/?appname=delete-example&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">,</span> <span class="s">&quot;test&quot;</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">bson_oid_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">BSON_APPEND_OID</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">);</span>
   <span class="n">BSON_APPEND_UTF8</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_collection_insert_one</span> <span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Insert failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>

   <span class="n">doc</span> <span class="o">=</span> <span class="n">bson_new</span> <span class="p">();</span>
   <span class="n">BSON_APPEND_OID</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mongoc_collection_delete_one</span> <span class="p">(</span>
          <span class="n">collection</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Delete failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile the code and run it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o delete delete.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./delete
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 delete.c
C:\&gt; delete
</pre></div>
</div>
<p>Use the MongoDB shell to prove that the documents have been removed successfully.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mongo
MongoDB shell version: 3.0.6
connecting to: test
&gt; use mydb
switched to db mydb
&gt; db.mycoll.count({&quot;hello&quot; : &quot;world&quot;})
0
&gt;
</pre></div>
</div>
</div>
<div class="section" id="counting-documents">
<h3>Counting Documents<a class="headerlink" href="#counting-documents" title="Permalink to this headline">¶</a></h3>
<p>Counting the number of documents in a MongoDB collection is similar to performing a <a class="reference internal" href="#tutorial-find"><span class="std std-ref">find operation</span></a>. This example counts the number of documents matching <code class="docutils literal notranslate"><span class="pre">{&quot;hello&quot;</span> <span class="pre">:</span> <span class="pre">&quot;world&quot;}</span></code> in the database “mydb” and collection “mycoll”.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">doc</span><span class="p">;</span>
   <span class="kt">int64_t</span> <span class="n">count</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">client</span> <span class="o">=</span>
      <span class="n">mongoc_client_new</span> <span class="p">(</span><span class="s">&quot;mongodb://localhost:27017/?appname=count-example&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;mydb&quot;</span><span class="p">,</span> <span class="s">&quot;mycoll&quot;</span><span class="p">);</span>
   <span class="n">doc</span> <span class="o">=</span> <span class="n">bson_new_from_json</span> <span class="p">(</span>
      <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">hello</span><span class="se">\&quot;</span><span class="s"> : </span><span class="se">\&quot;</span><span class="s">world</span><span class="se">\&quot;</span><span class="s">}&quot;</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="n">count</span> <span class="o">=</span> <span class="n">mongoc_collection_count</span> <span class="p">(</span>
      <span class="n">collection</span><span class="p">,</span> <span class="n">MONGOC_QUERY_NONE</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%&quot;</span> <span class="n">PRId64</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">doc</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile the code and run it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o count count.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./count
1
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 count.c
C:\&gt; count
1
</pre></div>
</div>
</div>
</div>
<div class="section" id="executing-commands">
<span id="tutorial-executing-commands"></span><h2><a class="toc-backref" href="#id14">Executing Commands</a><a class="headerlink" href="#executing-commands" title="Permalink to this headline">¶</a></h2>
<p>The driver provides helper functions for executing MongoDB commands on client, database and collection structures. These functions return <a class="reference internal" href="mongoc_cursor_t.html"><span class="doc">cursors</span></a>; the <code class="docutils literal notranslate"><span class="pre">_simple</span></code> variants return booleans indicating success or failure.</p>
<p>This example executes the <a class="reference external" href="http://docs.mongodb.org/manual/reference/command/collStats/">collStats</a> command against the collection “mycoll” in database “mydb”.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bson/bson.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">mongoc_collection_t</span> <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="o">*</span><span class="n">command</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">reply</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_new</span> <span class="p">(</span>
      <span class="s">&quot;mongodb://localhost:27017/?appname=executing-example&quot;</span><span class="p">);</span>
   <span class="n">collection</span> <span class="o">=</span> <span class="n">mongoc_client_get_collection</span> <span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;mydb&quot;</span><span class="p">,</span> <span class="s">&quot;mycoll&quot;</span><span class="p">);</span>

   <span class="n">command</span> <span class="o">=</span> <span class="n">BCON_NEW</span> <span class="p">(</span><span class="s">&quot;collStats&quot;</span><span class="p">,</span> <span class="n">BCON_UTF8</span> <span class="p">(</span><span class="s">&quot;mycoll&quot;</span><span class="p">));</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">mongoc_collection_command_simple</span> <span class="p">(</span>
          <span class="n">collection</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">str</span> <span class="o">=</span> <span class="n">bson_as_canonical_extended_json</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
      <span class="n">bson_free</span> <span class="p">(</span><span class="n">str</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Failed to run command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="n">mongoc_collection_destroy</span> <span class="p">(</span><span class="n">collection</span><span class="p">);</span>
   <span class="n">mongoc_client_destroy</span> <span class="p">(</span><span class="n">client</span><span class="p">);</span>
   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Compile the code and run it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ gcc -o executing executing.c $(pkg-config --cflags --libs libmongoc-1.0)
$ ./executing
{ &quot;ns&quot; : &quot;mydb.mycoll&quot;, &quot;count&quot; : 1, &quot;size&quot; : 48, &quot;avgObjSize&quot; : 48, &quot;numExtents&quot; : 1, &quot;storageSize&quot; : 8192,
&quot;lastExtentSize&quot; : 8192.000000, &quot;paddingFactor&quot; : 1.000000, &quot;userFlags&quot; : 1, &quot;capped&quot; : false, &quot;nindexes&quot; : 1,
&quot;indexDetails&quot; : {  }, &quot;totalIndexSize&quot; : 8176, &quot;indexSizes&quot; : { &quot;_id_&quot; : 8176 }, &quot;ok&quot; : 1.000000 }
</pre></div>
</div>
<p>On Windows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>C:\&gt; cl.exe /IC:\mongo-c-driver\include\libbson-1.0 /IC:\mongo-c-driver\include\libmongoc-1.0 executing.c
C:\&gt; executing
{ &quot;ns&quot; : &quot;mydb.mycoll&quot;, &quot;count&quot; : 1, &quot;size&quot; : 48, &quot;avgObjSize&quot; : 48, &quot;numExtents&quot; : 1, &quot;storageSize&quot; : 8192,
&quot;lastExtentSize&quot; : 8192.000000, &quot;paddingFactor&quot; : 1.000000, &quot;userFlags&quot; : 1, &quot;capped&quot; : false, &quot;nindexes&quot; : 1,
&quot;indexDetails&quot; : {  }, &quot;totalIndexSize&quot; : 8176, &quot;indexSizes&quot; : { &quot;_id_&quot; : 8176 }, &quot;ok&quot; : 1.000000 }
</pre></div>
</div>
</div>
<div class="section" id="threading">
<h2><a class="toc-backref" href="#id15">Threading</a><a class="headerlink" href="#threading" title="Permalink to this headline">¶</a></h2>
<p>The MongoDB C Driver is thread-unaware in the vast majority of its operations. This means it is up to the programmer to guarantee thread-safety.</p>
<p>However, <a class="symbol reference internal" href="mongoc_client_pool_t.html"><span class="doc">mongoc_client_pool_t</span></a> is thread-safe and is used to fetch a <code class="docutils literal notranslate"><span class="pre">mongoc_client_t</span></code> in a thread-safe manner. After retrieving a client from the pool, the client structure should be considered owned by the calling thread. When the thread is finished, the client should be placed back into the pool.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">example-pool.c</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* gcc example-pool.c -o example-pool $(pkg-config --cflags --libs</span>
<span class="cm"> * libmongoc-1.0) */</span>

<span class="cm">/* ./example-pool [CONNECTION_STRING] */</span>

<span class="cp">#include</span> <span class="cpf">&lt;mongoc/mongoc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="n">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">bool</span> <span class="n">in_shutdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="n">worker</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">mongoc_client_pool_t</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
   <span class="n">mongoc_client_t</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
   <span class="n">bson_t</span> <span class="n">ping</span> <span class="o">=</span> <span class="n">BSON_INITIALIZER</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">r</span><span class="p">;</span>

   <span class="n">BSON_APPEND_INT32</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ping</span><span class="p">,</span> <span class="s">&quot;ping&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

   <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">client</span> <span class="o">=</span> <span class="n">mongoc_client_pool_pop</span> <span class="p">(</span><span class="n">pool</span><span class="p">);</span>
      <span class="cm">/* Do something with client. If you are writing an HTTP server, you</span>
<span class="cm">       * probably only want to hold onto the client for the portion of the</span>
<span class="cm">       * request performing database queries.</span>
<span class="cm">       */</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">mongoc_client_command_simple</span> <span class="p">(</span>
         <span class="n">client</span><span class="p">,</span> <span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ping</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">mongoc_client_pool_push</span> <span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>

      <span class="n">pthread_mutex_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_shutdown</span> <span class="o">||</span> <span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">pthread_mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">pthread_mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">bson_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ping</span><span class="p">);</span>
   <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri_string</span> <span class="o">=</span> <span class="s">&quot;mongodb://127.0.0.1/?appname=pool-example&quot;</span><span class="p">;</span>
   <span class="n">mongoc_uri_t</span> <span class="o">*</span><span class="n">uri</span><span class="p">;</span>
   <span class="n">bson_error_t</span> <span class="n">error</span><span class="p">;</span>
   <span class="n">mongoc_client_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>
   <span class="n">pthread_t</span> <span class="n">threads</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
   <span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
   <span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

   <span class="n">pthread_mutex_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="n">mongoc_init</span> <span class="p">();</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">uri_string</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
   <span class="p">}</span>

   <span class="n">uri</span> <span class="o">=</span> <span class="n">mongoc_uri_new_with_error</span> <span class="p">(</span><span class="n">uri_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
               <span class="s">&quot;failed to parse URI: %s</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;error message:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">uri_string</span><span class="p">,</span>
               <span class="n">error</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">pool</span> <span class="o">=</span> <span class="n">mongoc_client_pool_new</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>
   <span class="n">mongoc_client_pool_set_error_api</span> <span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pthread_create</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">sleep</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
   <span class="n">pthread_mutex_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
   <span class="n">in_shutdown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
   <span class="n">pthread_mutex_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pthread_join</span> <span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">mongoc_client_pool_destroy</span> <span class="p">(</span><span class="n">pool</span><span class="p">);</span>
   <span class="n">mongoc_uri_destroy</span> <span class="p">(</span><span class="n">uri</span><span class="p">);</span>

   <span class="n">mongoc_cleanup</span> <span class="p">();</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h2><a class="toc-backref" href="#id16">Next Steps</a><a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>To find information on advanced topics, browse the rest of the <a class="reference internal" href="index.html"><span class="doc">C driver guide</span></a> or the <a class="reference external" href="https://docs.mongodb.org">official MongoDB documentation</a>.</p>
<p>For help with common issues, consult the <a class="reference internal" href="basic-troubleshooting.html"><span class="doc">Troubleshooting</span></a> page. To report a bug or request a new feature, follow <a class="reference internal" href="basic-troubleshooting.html#basic-troubleshooting-file-bug"><span class="std std-ref">these instructions</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing the MongoDB C Driver (libmongoc) and BSON library (libbson)</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installing">Installing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-mongodb">Starting MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="#include-and-link-libmongoc-in-your-c-program">Include and link libmongoc in your C program</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-libmongoc-in-a-microsoft-visual-studio-project">Use libmongoc in a Microsoft Visual Studio Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-a-connection">Making a Connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-bson-documents">Creating BSON Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-crud-operations">Basic CRUD Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#executing-commands">Executing Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="#threading">Threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic-troubleshooting.html">Basic Troubleshooting</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="guides.html">Guides</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="application-performance-monitoring.html">Application Performance Monitoring (APM)</a></li>
</ul>
<!-- Because full_index.rst includes everything that index.rst includes, we have to exclude index.rst from the table-of-contents. This page is simply a link forced into the sidebar (in conf.py) to avoid including full_index.rst in the ToC. -->
<ul><li class='toctree-l1'><a href="full_index.html">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2017-present, MongoDB, Inc.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.1.
  </div>
  
  </body>
</html>